# 草藥配伍驗證完整指南

## 一、欄位解釋：`sub_matched_count` 的意義

### 資料結構解析

在 `herb_association_analysis_improved.csv` 中，每一行記錄代表一個**核心草藥組合 (Core Combination)** 及其**配伍草藥 (Substitutes/Complements)**。

#### 核心欄位說明

| 欄位名稱 | 意義 | 範例值 |
|---------|------|--------|
| **core_combo** | 核心草藥組合（來自古籍處方） | 五味子、山藥、牛膝、肉蓯蓉 |
| **core_herbs_count** | 核心草藥總數 | 4 |
| **core_matched_count** | 核心草藥中能在 SymMap 找到的數量 | 4 |
| **core_matched_rate** | 核心草藥匹配率 | 1.0 (100%) |
| **core_herb_ids** | 匹配到的 SymMap Herb_id | 41, 359, 304, 338 |

#### 配伍欄位說明（重點）

| 欄位名稱 | 意義 | 範例值 |
|---------|------|--------|
| **top_substitutes** | 配伍草藥（可與核心組合搭配的草藥） | 柏子仁、天門冬、熟地黃、杜仲... |
| **sub_herbs_count** | 配伍草藥總數 | 12 |
| **sub_matched_count** | **配伍草藥中能在 SymMap 找到的數量** | 11 |
| **sub_matched_rate** | 配伍草藥匹配率 | 0.9167 (91.67%) |
| **sub_matched_names** | 匹配成功的配伍草藥名稱 | 柏子仁, 熟地黃, 杜仲... |
| **sub_unmatched_names** | 未匹配的配伍草藥名稱 | 天門冬 |
| **sub_herb_ids** | 匹配到的配伍草藥 Herb_id | 30, 377, 114, 480... |

### `sub_matched_count` 具體含義

**定義**: 在配伍草藥清單中，有多少個草藥能夠在 SymMap 資料庫中找到對應的 Herb_id。

**重要性**:
1. **匹配度越高** = 配伍草藥在現代藥理資料庫中的資料越完整
2. **可用於驗證** = 這些草藥有化學成分、靶點、疾病等資料可供分析
3. **配伍合理性驗證** = 可透過共同靶點、共同疾病等指標驗證配伍是否有科學依據

---

## 二、範例解讀

### 範例 1: 高匹配率組合（Community 0, Core 1）

```csv
core_combo: 五味子、山藥、牛膝、肉蓯蓉
core_matched_count: 4/4 (100%)
core_herb_ids: 41, 359, 304, 338

top_substitutes: 柏子仁、天門冬、熟地黃、杜仲、澤瀉、熟地黄、肉桂、山茱萸、當歸、酸棗仁、紫石英、丹參
sub_matched_count: 11/12 (91.67%)
sub_matched_names: 柏子仁, 熟地黃, 杜仲, 澤瀉, 熟地黄, 肉桂, 山茱萸, 當歸, 酸棗仁, 紫石英, 丹參
sub_unmatched_names: 天門冬
sub_herb_ids: 30, 377, 114, 480, 377, 340, 361, 95, 386, 665, 93
```

**解讀**:
- ✅ 核心組合 4 味藥全部能在 SymMap 找到
- ✅ 配伍草藥 12 味中 11 味能找到（91.67% 覆蓋率）
- ⚠️ 只有「天門冬」未能匹配（可能是簡繁體問題或 SymMap 未收錄）
- **後續可驗證**: 這 4+11=15 味草藥的化學成分、共同靶點、作用疾病

### 範例 2: 低匹配率組合（Community 2, Core 1）

```csv
core_combo: 金箔、銀箔、龍齒
core_matched_count: 0/3 (0%)
core_herb_ids: 空

top_substitutes: 牛黃、龍腦、珍珠、沙參、犀角、鐵粉、雄黃、琥珀、鉛霜、龍膽、麝香、虎睛
sub_matched_count: 5/12 (41.67%)
sub_matched_names: 牛黃, 珍珠, 雄黃, 龍膽, 麝香
sub_unmatched_names: 龍腦, 沙參, 犀角, 鐵粉, 琥珀, 鉛霜, 虎睛
sub_herb_ids: 303, 613, 664, 251, 702
```

**解讀**:
- ❌ 核心組合 3 味藥（金箔、銀箔、龍齒）全部未匹配
  - 原因: 這些是礦物藥，SymMap 主要收錄植物藥
- ⚠️ 配伍草藥只有 41.67% 匹配率
- **後續處理**:
  - 礦物藥需要查詢其他資料庫（如 TCMID）
  - 或跳過此組合，專注於植物藥配伍

---

## 三、後續驗證策略

### 🎯 驗證目標

驗證古籍處方中的「核心草藥 + 配伍草藥」組合是否有**現代藥理學證據**支持其配伍合理性。

---

### 📊 驗證方法 1: 共同靶點分析（Target-based Validation）

#### 原理
如果兩味草藥作用於**相同或相關的靶點基因/蛋白質**，則它們可能具有協同作用。

#### 步驟

**Step 1: 提取核心草藥和配伍草藥的 Herb_id**

```python
import pandas as pd

# 載入分析結果
df = pd.read_csv("herb_association_analysis_improved.csv")

# 選擇高匹配率的組合（例如 core_matched_rate >= 0.75 且 sub_matched_rate >= 0.75）
high_quality = df[(df['core_matched_rate'] >= 0.75) & (df['sub_matched_rate'] >= 0.75)]

# 提取第一組作為範例
row = high_quality.iloc[0]
core_ids = [int(x.strip()) for x in row['core_herb_ids'].split(',')]
sub_ids = [int(x.strip()) for x in row['sub_herb_ids'].split(',')]

print(f"核心草藥 IDs: {core_ids}")
print(f"配伍草藥 IDs: {sub_ids}")
```

**Step 2: 查詢草藥對應的化學成分**

```python
# 載入 SymMap 整合表
df_master = pd.read_csv("SymMap_Master_Table.csv")

# 查詢核心草藥的成分
core_ingredients = df_master[df_master['Herb_id'].isin(core_ids)]
core_mol_ids = core_ingredients['Mol_id'].dropna().unique()

# 查詢配伍草藥的成分
sub_ingredients = df_master[df_master['Herb_id'].isin(sub_ids)]
sub_mol_ids = sub_ingredients['Mol_id'].dropna().unique()

print(f"核心草藥化學成分數: {len(core_mol_ids)}")
print(f"配伍草藥化學成分數: {len(sub_mol_ids)}")
```

**Step 3: 查詢成分對應的靶點基因**

⚠️ **問題**: SymMap 的 SMIT 表沒有直接提供 Mol_id → Gene_id 關聯

**解決方案**:
1. **使用 SymMap 網站 API** (推薦)
   ```python
   import requests

   def get_targets_from_symmap(mol_id):
       """透過 SymMap API 查詢成分對應的靶點"""
       url = f"http://www.symmap.org/api/molecule/{mol_id}/targets"
       response = requests.get(url)
       if response.status_code == 200:
           return response.json()
       return None
   ```

2. **整合外部資料庫**
   - STITCH (化學物-蛋白質交互作用資料庫)
   - PubChem BioAssay
   - ChEMBL

3. **使用 PubChem_CID 作為橋樑**
   ```python
   # 從 SymMap_Master_Table 中取得 PubChem_CID
   pubchem_ids = core_ingredients['PubChem_CID'].dropna().unique()
   # 再查詢 PubChem → 靶點資料庫
   ```

**Step 4: 計算共同靶點比例**

```python
import numpy as np

# 假設已取得靶點資料
core_targets = set([...])  # 核心草藥的靶點基因集合
sub_targets = set([...])   # 配伍草藥的靶點基因集合

# 計算重疊
common_targets = core_targets & sub_targets
jaccard_similarity = len(common_targets) / len(core_targets | sub_targets)

print(f"共同靶點數量: {len(common_targets)}")
print(f"Jaccard 相似度: {jaccard_similarity:.3f}")

# 驗證結論
if jaccard_similarity > 0.3:
    print("✅ 高度重疊，配伍可能具有協同作用")
elif jaccard_similarity > 0.1:
    print("⚠️ 中度重疊，配伍可能有相關性")
else:
    print("❌ 低度重疊，配伍相關性待確認")
```

---

### 📊 驗證方法 2: 共同疾病分析（Disease-based Validation）

#### 原理
如果核心草藥和配伍草藥都治療**相同或相關的疾病**，則配伍合理。

#### 步驟

**Step 1: 查詢草藥對應的疾病**

```python
# 載入疾病參考表
df_diseases = pd.read_excel("SymMap_Reference_Tables/diseases_reference.xlsx")

# 需要建立 Herb_id → Disease_id 的關聯
# 方式 1: 透過 SymMap API
# 方式 2: 使用 SMDE key file 進行關聯
# 方式 3: 透過 Target → Disease 路徑（使用 DisGeNET）
```

**Step 2: 疾病相似度分析**

```python
from collections import Counter

# 假設已取得疾病資料
core_diseases = [...]  # 核心草藥治療的疾病列表
sub_diseases = [...]   # 配伍草藥治療的疾病列表

# 計算重疊疾病
common_diseases = set(core_diseases) & set(sub_diseases)

print(f"核心草藥治療疾病數: {len(core_diseases)}")
print(f"配伍草藥治療疾病數: {len(sub_diseases)}")
print(f"共同治療疾病數: {len(common_diseases)}")
print(f"共同疾病: {common_diseases}")
```

---

### 📊 驗證方法 3: 藥性理論驗證（TCM Theory-based）

#### 原理
根據中醫藥性理論，驗證配伍是否符合「四氣五味」、「歸經」、「配伍禁忌」等原則。

#### 步驟

**Step 1: 提取草藥藥性資料**

```python
# 從 SymMap_Master_Table 提取藥性
df_master = pd.read_csv("SymMap_Master_Table.csv")

# 查詢核心草藥藥性
core_properties = df_master[df_master['Herb_id'].isin(core_ids)][
    ['Herb_id', 'Herb_Chinese', 'Properties_Chinese', 'Meridians_Chinese', 'Class_Chinese']
].drop_duplicates()

print(core_properties)
```

**Step 2: 藥性相容性分析**

```python
def check_property_compatibility(properties_list):
    """檢查藥性相容性"""
    # 提取四氣
    qi_list = []
    for prop in properties_list:
        if '寒' in prop:
            qi_list.append('寒')
        elif '熱' in prop or '温' in prop:
            qi_list.append('熱')
        # ... 其他四氣

    # 檢查是否有寒熱並用（可能需要特殊理論支持）
    if '寒' in qi_list and '熱' in qi_list:
        return "⚠️ 寒熱並用，需確認配伍理論"

    return "✅ 藥性相容"

# 分析核心組合
core_props = core_properties['Properties_Chinese'].tolist()
result = check_property_compatibility(core_props)
print(result)
```

**Step 3: 歸經相關性分析**

```python
from collections import Counter

# 統計歸經
all_meridians = []
for meridian in core_properties['Meridians_Chinese']:
    if pd.notna(meridian):
        all_meridians.extend(meridian.split(','))

meridian_counts = Counter(all_meridians)
print(f"主要歸經: {meridian_counts.most_common(3)}")

# 判斷
if len(meridian_counts.most_common(1)) > 0:
    main_meridian, count = meridian_counts.most_common(1)[0]
    if count >= len(core_ids) * 0.5:
        print(f"✅ 主要歸經為 {main_meridian}，配伍具有針對性")
```

---

### 📊 驗證方法 4: 網絡藥理學分析（Network Pharmacology）

#### 原理
建立「草藥-成分-靶點-疾病」多層網絡，分析網絡拓撲特徵。

#### 步驟

**Step 1: 建立草藥-成分-靶點網絡**

```python
import networkx as nx
import matplotlib.pyplot as plt

# 建立多層網絡
G = nx.Graph()

# 添加草藥-成分邊
for _, row in df_master[df_master['Herb_id'].isin(core_ids)].iterrows():
    if pd.notna(row['Mol_id']):
        G.add_edge(
            f"Herb_{row['Herb_id']}",
            f"Mol_{int(row['Mol_id'])}",
            type='herb-ingredient'
        )

# 添加成分-靶點邊（需要額外資料）
# 假設有 ingredient_target_mapping
for mol_id, target_id in ingredient_target_mapping.items():
    G.add_edge(f"Mol_{mol_id}", f"Target_{target_id}", type='ingredient-target')

print(f"網絡節點數: {G.number_of_nodes()}")
print(f"網絡邊數: {G.number_of_edges()}")
```

**Step 2: 計算網絡中心性**

```python
# 計算度中心性
degree_centrality = nx.degree_centrality(G)

# 找出核心靶點（度數最高的靶點節點）
targets = {k: v for k, v in degree_centrality.items() if k.startswith('Target_')}
top_targets = sorted(targets.items(), key=lambda x: x[1], reverse=True)[:10]

print("核心靶點 Top 10:")
for target, centrality in top_targets:
    print(f"  {target}: {centrality:.3f}")
```

**Step 3: 視覺化網絡**

```python
plt.figure(figsize=(15, 10))

# 設定節點顏色
node_colors = []
for node in G.nodes():
    if node.startswith('Herb_'):
        node_colors.append('lightblue')
    elif node.startswith('Mol_'):
        node_colors.append('lightgreen')
    elif node.startswith('Target_'):
        node_colors.append('salmon')
    else:
        node_colors.append('gray')

# 繪製網絡
pos = nx.spring_layout(G, k=0.5, iterations=50)
nx.draw(G, pos, node_color=node_colors, node_size=300,
        with_labels=True, font_size=8, alpha=0.7)

plt.title("Herb-Ingredient-Target Network")
plt.savefig("network_visualization.png", dpi=300, bbox_inches='tight')
print("網絡圖已儲存至 network_visualization.png")
```

---

## 四、完整驗證流程範例

### 🔬 實戰案例：驗證「五味子、山藥、牛膝、肉蓯蓉」組合

```python
#!/usr/bin/env python3
"""
草藥配伍驗證完整範例
驗證 Community 0, Core 1 組合
"""

import pandas as pd
import numpy as np
from collections import Counter

# ============ 步驟 1: 載入資料 ============
print("步驟 1: 載入分析結果")
df_analysis = pd.read_csv("herb_association_analysis_improved.csv")
df_master = pd.read_csv("SymMap_Master_Table.csv")

# 選擇目標組合
target_row = df_analysis[(df_analysis['community'] == 0) & (df_analysis['core_index'] == 1)].iloc[0]

print(f"核心組合: {target_row['core_combo']}")
print(f"配伍草藥: {target_row['top_substitutes']}")
print(f"sub_matched_count: {target_row['sub_matched_count']}/{target_row['sub_herbs_count']}")
print()

# ============ 步驟 2: 提取 Herb_id ============
core_ids = [int(x.strip()) for x in target_row['core_herb_ids'].split(',') if x.strip()]
sub_ids = [int(x.strip()) for x in target_row['sub_herb_ids'].split(',') if x.strip()]
all_ids = core_ids + sub_ids

print(f"步驟 2: 提取 Herb_id")
print(f"核心草藥 IDs: {core_ids}")
print(f"配伍草藥 IDs: {sub_ids}")
print()

# ============ 步驟 3: 查詢化學成分 ============
print("步驟 3: 查詢化學成分")
all_herbs_data = df_master[df_master['Herb_id'].isin(all_ids)]

# 統計有成分資料的草藥
herbs_with_ingredients = all_herbs_data[all_herbs_data['Mol_id'].notna()]['Herb_id'].unique()
print(f"有成分資料的草藥數: {len(herbs_with_ingredients)}/{len(all_ids)}")

if len(herbs_with_ingredients) > 0:
    print("有成分資料的草藥:")
    for herb_id in herbs_with_ingredients:
        herb_name = df_master[df_master['Herb_id'] == herb_id]['Herb_Chinese'].iloc[0]
        mol_count = len(all_herbs_data[all_herbs_data['Herb_id'] == herb_id])
        print(f"  - {herb_name} (ID={herb_id}): {mol_count} 個成分")
else:
    print("⚠️ 警告: 所有草藥都沒有成分資料，無法進行靶點分析")
print()

# ============ 步驟 4: 藥性分析 ============
print("步驟 4: 中醫藥性分析")
herbs_info = df_master[df_master['Herb_id'].isin(all_ids)][
    ['Herb_id', 'Herb_Chinese', 'Properties_Chinese', 'Meridians_Chinese', 'Class_Chinese']
].drop_duplicates()

print("\n核心草藥藥性:")
for _, row in herbs_info[herbs_info['Herb_id'].isin(core_ids)].iterrows():
    print(f"  {row['Herb_Chinese']}: {row['Properties_Chinese']} / {row['Meridians_Chinese']} / {row['Class_Chinese']}")

# 統計歸經
all_meridians = []
for meridian in herbs_info['Meridians_Chinese'].dropna():
    all_meridians.extend([m.strip() for m in str(meridian).split(',')])

meridian_counts = Counter(all_meridians)
print(f"\n主要歸經分布:")
for meridian, count in meridian_counts.most_common(5):
    print(f"  {meridian}: {count} 次")

# ============ 步驟 5: 生成驗證報告 ============
print("\n" + "="*80)
print("驗證報告總結")
print("="*80)

report = f"""
組合名稱: {target_row['core_combo']}
核心草藥數量: {len(core_ids)}
配伍草藥數量: {len(sub_ids)}
SymMap 匹配率: {target_row['sub_matched_count']}/{target_row['sub_herbs_count']} ({target_row['sub_matched_rate']*100:.1f}%)

化學成分資料:
  - 有成分資料的草藥: {len(herbs_with_ingredients)}/{len(all_ids)} ({len(herbs_with_ingredients)/len(all_ids)*100:.1f}%)
  - 總成分數: {len(all_herbs_data['Mol_id'].dropna().unique())}

藥性分析:
  - 主要歸經: {', '.join([f"{m}({c})" for m, c in meridian_counts.most_common(3)])}

驗證建議:
"""

if len(herbs_with_ingredients) >= len(all_ids) * 0.5:
    report += "  ✅ 化學成分資料充足，可進行靶點分析\n"
else:
    report += "  ⚠️ 化學成分資料不足，建議補充 TCMSP/TCMID 資料\n"

if target_row['sub_matched_rate'] >= 0.75:
    report += "  ✅ SymMap 匹配率高，資料品質良好\n"
else:
    report += "  ⚠️ SymMap 匹配率偏低，部分草藥可能需要手動查證\n"

print(report)
```

---

## 五、驗證結果評估標準

### 評分標準

| 指標 | 權重 | 評分標準 |
|------|------|----------|
| **SymMap 匹配率** | 20% | sub_matched_rate ≥ 0.75 → 優秀<br>0.5-0.75 → 良好<br>< 0.5 → 需改進 |
| **化學成分覆蓋率** | 25% | 有成分草藥 ≥ 70% → 優秀<br>30-70% → 良好<br>< 30% → 資料不足 |
| **共同靶點比例** | 30% | Jaccard > 0.3 → 高度相關<br>0.1-0.3 → 中度相關<br>< 0.1 → 低度相關 |
| **共同疾病數量** | 15% | ≥ 5 個 → 優秀<br>2-4 個 → 良好<br>< 2 個 → 待確認 |
| **中醫理論一致性** | 10% | 歸經重疊 ≥ 50% → 優秀<br>藥性相容 → 良好 |

### 驗證結論模板

```
【驗證組合】: 五味子、山藥、牛膝、肉蓯蓉 + 配伍草藥

【資料品質】:
  - SymMap 匹配率: 91.67% ✅
  - 化學成分覆蓋率: 8.3% ❌ (需補充資料)

【藥理學驗證】:
  - 共同靶點: X 個 (Jaccard = X.XX)
  - 共同疾病: X 個
  - 結論: [高度相關/中度相關/低度相關]

【中醫理論驗證】:
  - 主要歸經: 肝經、腎經
  - 藥性相容性: ✅
  - 配伍禁忌: 未發現

【總體結論】:
  ✅ 推薦進行臨床驗證
  ⚠️ 需補充資料後再驗證
  ❌ 配伍證據不足
```

---

## 六、工具腳本推薦

### 建議建立的驗證工具

1. **`validate_herb_combination.py`** - 自動化驗證腳本
2. **`extract_shared_targets.py`** - 提取共同靶點
3. **`visualize_network.py`** - 視覺化草藥網絡
4. **`generate_validation_report.py`** - 生成驗證報告

需要我為您建立這些工具嗎？

---

## 七、後續行動建議

### 短期（1-2 週）

1. ✅ 完成高匹配率組合的藥性分析
2. ⬜ 建立 Herb_id → Target 查詢工具（使用 SymMap API 或 STITCH）
3. ⬜ 對前 5 組配伍進行完整驗證

### 中期（1-2 月）

4. ⬜ 補充 TCMSP/TCMID 資料，提升化學成分覆蓋率
5. ⬜ 整合 DisGeNET，建立 Target → Disease 關聯
6. ⬜ 建立自動化驗證流程

### 長期（3-6 月）

7. ⬜ 建立完整的網絡藥理學分析平台
8. ⬜ 發表配伍驗證研究論文
9. ⬜ 開發配伍推薦系統

---

**參考文獻**:
- Zhang, R. et al. (2019). Network pharmacology databases for TCM. *Pharmacological Research*, 147.
- Li, S. & Zhang, B. (2013). Traditional Chinese medicine network pharmacology. *Computational and Structural Biotechnology Journal*, 11(18).

**生成日期**: 2025-10-22
**版本**: v1.0
